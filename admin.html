// ============================================
// –ê–î–ú–ò–ù-–ë–û–¢ –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–ê–ì–ê–ó–ò–ù–û–ú
// ============================================

const TelegramBot = require('8322585096:AAGE-K4-ookzENT73A9iMQl4aj5uXC4AEqA');
const { Octokit } = require('@octokit/rest');
const axios = require('axios');

// ============================================
// –ù–ê–°–¢–†–û–ô–ö–ò - –ó–ê–ü–û–õ–ù–ò–¢–ï –≠–¢–ò –î–ê–ù–ù–´–ï!
// ============================================

const CONFIG = {
    // –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç @BotFather
    BOT_TOKEN: '6123456789:AAH1234567890abcdefghijklmnopqrstuvw',
    
    // GitHub –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    GITHUB: {
        // –¢–æ–∫–µ–Ω –∏–∑ —à–∞–≥–∞ 2.1
        TOKEN: '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',
        // –í–∞—à –ª–æ–≥–∏–Ω –Ω–∞ GitHub
        OWNER: 'geyda379-svg',
        // –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        REPO: 'proba1',
        // –í–µ—Ç–∫–∞
        BRANCH: 'main',
        // –§–∞–π–ª —Å —Ç–æ–≤–∞—Ä–∞–º–∏
        FILE_PATH: 'products.json'
    },
    
    // ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (–≤–∞—à ID –∏–∑ @userinfobot)
    ADMIN_IDS: [6403638379], // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞
    SHOP: {
        MAX_PRODUCTS: 1000,
        DEFAULT_CATEGORIES: [
            'electronics', 'clothes', 'books', 
            'food', 'home', 'sports', 'other'
        ],
        CURRENCY: '‚ÇΩ'
    }
};

// ============================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ============================================

const bot = new TelegramBot(CONFIG.BOT_TOKEN, { 
    polling: true,
    filepath: false
});

const octokit = new Octokit({
    auth: CONFIG.GITHUB.TOKEN
});

let productsCache = [];
let userStates = {};

// ============================================
// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° GITHUB
// ============================================

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
async function getProducts() {
    try {
        const { data } = await octokit.repos.getContent({
            owner: CONFIG.GITHUB.OWNER,
            repo: CONFIG.GITHUB.REPO,
            path: CONFIG.GITHUB.FILE_PATH,
            ref: CONFIG.GITHUB.BRANCH
        });
        
        const content = Buffer.from(data.content, 'base64').toString();
        productsCache = JSON.parse(content || '[]');
        return productsCache;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤:', error);
        return [];
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
async function saveProducts(products) {
    try {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SHA
        let sha;
        try {
            const { data } = await octokit.repos.getContent({
                owner: CONFIG.GITHUB.OWNER,
                repo: CONFIG.GITHUB.REPO,
                path: CONFIG.GITHUB.FILE_PATH,
                ref: CONFIG.GITHUB.BRANCH
            });
            sha = data.sha;
        } catch (e) {
            sha = null; // –§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        }
        
        const content = Buffer.from(JSON.stringify(products, null, 2)).toString('base64');
        
        await octokit.repos.createOrUpdateFileContents({
            owner: CONFIG.GITHUB.OWNER,
            repo: CONFIG.GITHUB.REPO,
            path: CONFIG.GITHUB.FILE_PATH,
            message: 'üõçÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞ –º–∞–≥–∞–∑–∏–Ω–∞',
            content: content,
            branch: CONFIG.GITHUB.BRANCH,
            sha: sha
        });
        
        productsCache = products;
        return true;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        return false;
    }
}

// ============================================
// –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê
// ============================================

// –ö–æ–º–∞–Ω–¥–∞ /start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
bot.onText(/\/start/, async (msg) => {
    const chatId = msg.chat.id;
    
    if (!CONFIG.ADMIN_IDS.includes(chatId)) {
        bot.sendMessage(chatId, '‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.');
        return;
    }
    
    await showMainMenu(chatId);
});

// –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
async function showMainMenu(chatId) {
    const products = await getProducts();
    const stats = await getShopStats();
    
    const menu = {
        reply_markup: {
            keyboard: [
                ['üì¶ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä', '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä'],
                ['üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä', 'üìã –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤'],
                ['üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏'],
                ['üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', 'üì§ –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤']
            ],
            resize_keyboard: true,
            one_time_keyboard: false
        }
    };
    
    const message = `üë®‚Äçüíº *–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞*\n\n` +
                   `üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞:*\n` +
                   `üõçÔ∏è –¢–æ–≤–∞—Ä–æ–≤: ${stats.totalProducts}\n` +
                   `üí∞ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${stats.totalValue} ${CONFIG.SHOP.CURRENCY}\n` +
                   `üìà –ö–∞—Ç–µ–≥–æ—Ä–∏–π: ${stats.categories}\n\n` +
                   `–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:`;
    
    bot.sendMessage(chatId, message, { 
        parse_mode: 'Markdown',
        ...menu 
    });
}

// ============================================
// –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–û–í–ê–†–ê
// ============================================

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "üì¶ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä"
bot.onText(/üì¶ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä/, async (msg) => {
    const chatId = msg.chat.id;
    
    userStates[chatId] = {
        action: 'adding_product',
        step: 1,
        product: {}
    };
    
    const categories = CONFIG.SHOP.DEFAULT_CATEGORIES.map(cat => 
        `‚Ä¢ ${getCategoryEmoji(cat)} ${cat}`
    ).join('\n');
    
    bot.sendMessage(chatId, 
        `üéØ *–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞*\n\n` +
        `–®–∞–≥ 1/5: –í–≤–µ–¥–∏—Ç–µ *–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞*\n\n` +
        `–ü—Ä–∏–º–µ—Ä—ã:\n` +
        `‚Ä¢ iPhone 15 Pro Max\n` +
        `‚Ä¢ –§—É—Ç–±–æ–ª–∫–∞ —á–µ—Ä–Ω–∞—è\n` +
        `‚Ä¢ –ö–Ω–∏–≥–∞ "JavaScript –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö"`,
        { parse_mode: 'Markdown' }
    );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–≥–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    const text = msg.text;
    
    if (!userStates[chatId] || CONFIG.ADMIN_IDS.indexOf(chatId) === -1) {
        return;
    }
    
    const state = userStates[chatId];
    
    if (state.action === 'adding_product') {
        switch (state.step) {
            case 1: // –ù–∞–∑–≤–∞–Ω–∏–µ
                state.product.name = text;
                state.step = 2;
                bot.sendMessage(chatId,
                    `‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ: *${text}*\n\n` +
                    `–®–∞–≥ 2/5: –í–≤–µ–¥–∏—Ç–µ *—Ü–µ–Ω—É* –≤ ${CONFIG.SHOP.CURRENCY}\n\n` +
                    `–ü—Ä–∏–º–µ—Ä: 9999`,
                    { parse_mode: 'Markdown' }
                );
                break;
                
            case 2: // –¶–µ–Ω–∞
                const price = parseFloat(text.replace(',', '.'));
                if (isNaN(price) || price <= 0) {
                    bot.sendMessage(chatId, '‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0:');
                    return;
                }
                state.product.price = price;
                state.step = 3;
                
                const categories = CONFIG.SHOP.DEFAULT_CATEGORIES.map((cat, index) => 
                    `${index + 1}. ${getCategoryEmoji(cat)} ${cat}`
                ).join('\n');
                
                bot.sendMessage(chatId,
                    `‚úÖ –¶–µ–Ω–∞: *${price} ${CONFIG.SHOP.CURRENCY}*\n\n` +
                    `–®–∞–≥ 3/5: –í—ã–±–µ—Ä–∏—Ç–µ *–∫–∞—Ç–µ–≥–æ—Ä–∏—é*:\n\n${categories}\n\n` +
                    `–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é:`,
                    { parse_mode: 'Markdown' }
                );
                break;
                
            case 3: // –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                let category = text.toLowerCase();
                const num = parseInt(text);
                
                if (!isNaN(num) && num > 0 && num <= CONFIG.SHOP.DEFAULT_CATEGORIES.length) {
                    category = CONFIG.SHOP.DEFAULT_CATEGORIES[num - 1];
                }
                
                state.product.category = category;
                state.step = 4;
                
                bot.sendMessage(chatId,
                    `‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: *${getCategoryEmoji(category)} ${category}*\n\n` +
                    `–®–∞–≥ 4/5: –í–≤–µ–¥–∏—Ç–µ *–æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞*\n\n` +
                    `–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫\n` +
                    `–ü—Ä–∏–º–µ—Ä: "–°–º–∞—Ä—Ç—Ñ–æ–Ω –æ—Ç Apple —Å —á–∏–ø–æ–º A17 Pro\\n–ü–∞–º—è—Ç—å: 256 –ì–ë\\n–¶–≤–µ—Ç: —á–µ—Ä–Ω—ã–π"`,
                    { parse_mode: 'Markdown' }
                );
                break;
                
            case 4: // –û–ø–∏—Å–∞–Ω–∏–µ
                state.product.description = text;
                state.step = 5;
                
                // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –Ω–∞–ª–∏—á–∏—è –Ω–∞ —Å–∫–ª–∞–¥–µ
                const stockKeyboard = {
                    reply_markup: {
                        keyboard: [
                            ['‚úÖ –í –Ω–∞–ª–∏—á–∏–∏', '‚è≥ –ü–æ–¥ –∑–∞–∫–∞–∑'],
                            ['üì¶ –ú–Ω–æ–≥–æ', 'üîÑ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ']
                        ],
                        resize_keyboard: true,
                        one_time_keyboard: true
                    }
                };
                
                bot.sendMessage(chatId,
                    `‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ\n\n` +
                    `–®–∞–≥ 5/5: –£–∫–∞–∂–∏—Ç–µ *–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ*\n\n` +
                    `–ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–∏—Å–ª–æ –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å:`,
                    { parse_mode: 'Markdown', ...stockKeyboard }
                );
                break;
                
            case 5: // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
                let stock = parseInt(text);
                if (isNaN(stock)) {
                    switch(text) {
                        case '‚úÖ –í –Ω–∞–ª–∏—á–∏–∏': stock = 100; break;
                        case '‚è≥ –ü–æ–¥ –∑–∞–∫–∞–∑': stock = 0; break;
                        case 'üì¶ –ú–Ω–æ–≥–æ': stock = 50; break;
                        case 'üîÑ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ': stock = 10; break;
                        default: stock = 1;
                    }
                }
                
                state.product.stock = stock;
                state.product.id = 'prod_' + Date.now();
                state.product.created_at = new Date().toISOString();
                state.product.updated_at = new Date().toISOString();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                await showProductPreview(chatId, state.product);
                break;
        }
    } else if (state.action === 'editing_product') {
        // –õ–æ–≥–∏–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        await handleProductEditing(chatId, text, state);
    }
});

// –ü—Ä–µ–≤—å—é –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
async function showProductPreview(chatId, product) {
    const keyboard = {
        reply_markup: {
            inline_keyboard: [
                [
                    { text: '‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä', callback_data: 'save_product' },
                    { text: '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å', callback_data: 'cancel_product' }
                ],
                [
                    { text: '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å', callback_data: 'edit_product' }
                ]
            ]
        }
    };
    
    const message = `üìã *–ü–†–ï–í–¨–Æ –¢–û–í–ê–†–ê*\n\n` +
                   `üÜî ID: \`${product.id}\`\n` +
                   `üì¶ –ù–∞–∑–≤–∞–Ω–∏–µ: *${product.name}*\n` +
                   `üí∞ –¶–µ–Ω–∞: *${product.price} ${CONFIG.SHOP.CURRENCY}*\n` +
                   `üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${getCategoryEmoji(product.category)} *${product.category}*\n` +
                   `üìù –û–ø–∏—Å–∞–Ω–∏–µ:\n${product.description}\n` +
                   `üìä –ù–∞ —Å–∫–ª–∞–¥–µ: *${product.stock} —à—Ç.*\n\n` +
                   `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä?`;
    
    bot.sendMessage(chatId, message, {
        parse_mode: 'Markdown',
        ...keyboard
    });
}

// ============================================
// –£–î–ê–õ–ï–ù–ò–ï –¢–û–í–ê–†–ê
// ============================================

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä"
bot.onText(/üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä/, async (msg) => {
    const chatId = msg.chat.id;
    const products = await getProducts();
    
    if (products.length === 0) {
        bot.sendMessage(chatId, 'üì≠ –ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç. –ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å.');
        return;
    }
    
    userStates[chatId] = {
        action: 'deleting_product',
        products: products
    };
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    const productList = products.slice(0, 50).map((p, i) => 
        `${i + 1}. ${p.name} - ${p.price} ${CONFIG.SHOP.CURRENCY}`
    ).join('\n');
    
    const message = `üóëÔ∏è *–£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞*\n\n` +
                   `–¢–æ–≤–∞—Ä–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: ${products.length}\n\n` +
                   `${productList}\n\n` +
                   `–û—Ç–ø—Ä–∞–≤—å—Ç–µ *–Ω–æ–º–µ—Ä —Ç–æ–≤–∞—Ä–∞* –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–ª–∏ *ID —Ç–æ–≤–∞—Ä–∞*:`;
    
    bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
});

// ============================================
// –°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í
// ============================================

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "üìã –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤"
bot.onText(/üìã –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤/, async (msg) => {
    const chatId = msg.chat.id;
    const products = await getProducts();
    
    if (products.length === 0) {
        bot.sendMessage(chatId, 'üì≠ –ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä!');
        return;
    }
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const categories = {};
    products.forEach(product => {
        if (!categories[product.category]) {
            categories[product.category] = [];
        }
        categories[product.category].push(product);
    });
    
    let message = `üìä *–ê–°–°–û–†–¢–ò–ú–ï–ù–¢ –ú–ê–ì–ê–ó–ò–ù–ê*\n\n` +
                 `–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: ${products.length}\n\n`;
    
    for (const [category, items] of Object.entries(categories)) {
        message += `${getCategoryEmoji(category)} *${category.toUpperCase()}* (${items.length}):\n`;
        items.slice(0, 5).forEach(item => {
            message += `‚Ä¢ ${item.name} - ${item.price} ${CONFIG.SHOP.CURRENCY}\n`;
        });
        if (items.length > 5) {
            message += `... –∏ –µ—â–µ ${items.length - 5} —Ç–æ–≤–∞—Ä–æ–≤\n`;
        }
        message += '\n';
    }
    
    // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏
    const keyboard = {
        reply_markup: {
            inline_keyboard: [
                [
                    { text: 'üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV', callback_data: 'export_csv' },
                    { text: 'üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON', callback_data: 'export_json' }
                ],
                [
                    { text: 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã', callback_data: 'update_prices' },
                    { text: 'üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', callback_data: 'show_stats' }
                ]
            ]
        }
    };
    
    bot.sendMessage(chatId, message, {
        parse_mode: 'Markdown',
        ...keyboard
    });
});

// ============================================
// –°–¢–ê–¢–ò–°–¢–ò–ö–ê
// ============================================

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
bot.onText(/üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞/, async (msg) => {
    const chatId = msg.chat.id;
    const stats = await getShopStats();
    
    const message = `üìà *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê*\n\n` +
                   `üõçÔ∏è –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: ${stats.totalProducts}\n` +
                   `üí∞ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${stats.totalValue} ${CONFIG.SHOP.CURRENCY}\n` +
                   `üìà –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: ${stats.averagePrice} ${CONFIG.SHOP.CURRENCY}\n` +
                   `üìä –ö–∞—Ç–µ–≥–æ—Ä–∏–π: ${stats.categories}\n` +
                   `üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${stats.lastUpdate}\n\n` +
                   `üèÜ *–¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ —Ü–µ–Ω–µ:*\n` +
                   `${stats.topExpensive.map((p, i) => 
                       `${i + 1}. ${p.name} - ${p.price} ${CONFIG.SHOP.CURRENCY}`
                   ).join('\n')}`;
    
    bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
});

// ============================================
// –û–ë–†–ê–ë–û–¢–ö–ê CALLBACK-QUERY (–∫–Ω–æ–ø–∫–∏ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏)
// ============================================

bot.on('callback_query', async (callbackQuery) => {
    const chatId = callbackQuery.message.chat.id;
    const data = callbackQuery.data;
    
    try {
        switch(data) {
            case 'save_product':
                const state = userStates[chatId];
                if (state && state.product) {
                    const products = await getProducts();
                    products.push(state.product);
                    const saved = await saveProducts(products);
                    
                    if (saved) {
                        bot.answerCallbackQuery(callbackQuery.id, { text: '‚úÖ –¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω!' });
                        bot.editMessageText(
                            `‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –º–∞–≥–∞–∑–∏–Ω!\n\n` +
                            `üì¶ *${state.product.name}*\n` +
                            `üí∞ ${state.product.price} ${CONFIG.SHOP.CURRENCY}\n\n` +
                            `–ú–∞–≥–∞–∑–∏–Ω –æ–±–Ω–æ–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`,
                            {
                                chat_id: chatId,
                                message_id: callbackQuery.message.message_id,
                                parse_mode: 'Markdown'
                            }
                        );
                        delete userStates[chatId];
                    }
                }
                break;
                
            case 'cancel_product':
                bot.answerCallbackQuery(callbackQuery.id, { text: '‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ' });
                bot.editMessageText('‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.', {
                    chat_id: chatId,
                    message_id: callbackQuery.message.message_id
                });
                delete userStates[chatId];
                break;
                
            case 'export_csv':
                await exportToCSV(chatId);
                bot.answerCallbackQuery(callbackQuery.id);
                break;
                
            case 'export_json':
                await exportToJSON(chatId);
                bot.answerCallbackQuery(callbackQuery.id);
                break;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback:', error);
        bot.answerCallbackQuery(callbackQuery.id, { text: '‚ùå –û—à–∏–±–∫–∞' });
    }
});

// ============================================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// ============================================

// –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function getCategoryEmoji(category) {
    const emojis = {
        'electronics': 'üì±',
        'clothes': 'üëï',
        'books': 'üìö',
        'food': 'üçî',
        'home': 'üè†',
        'sports': '‚öΩ',
        'other': 'üì¶'
    };
    return emojis[category] || 'üì¶';
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞
async function getShopStats() {
    const products = await getProducts();
    
    if (products.length === 0) {
        return {
            totalProducts: 0,
            totalValue: 0,
            averagePrice: 0,
            categories: 0,
            lastUpdate: '–Ω–∏–∫–æ–≥–¥–∞',
            topExpensive: []
        };
    }
    
    const categories = new Set(products.map(p => p.category));
    const totalValue = products.reduce((sum, p) => sum + (p.price || 0), 0);
    const averagePrice = Math.round(totalValue / products.length);
    
    // –¢–æ–ø 5 —Å–∞–º—ã—Ö –¥–æ—Ä–æ–≥–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
    const topExpensive = [...products]
        .sort((a, b) => b.price - a.price)
        .slice(0, 5);
    
    // –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    const lastUpdate = products.length > 0 
        ? new Date(products[products.length - 1].updated_at || products[products.length - 1].created_at)
            .toLocaleString('ru-RU')
        : '–Ω–∏–∫–æ–≥–¥–∞';
    
    return {
        totalProducts: products.length,
        totalValue: totalValue,
        averagePrice: averagePrice,
        categories: categories.size,
        lastUpdate: lastUpdate,
        topExpensive: topExpensive
    };
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
async function exportToCSV(chatId) {
    const products = await getProducts();
    
    if (products.length === 0) {
        bot.sendMessage(chatId, 'üì≠ –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.');
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º CSV
    const headers = ['ID', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–¶–µ–Ω–∞', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ù–∞ —Å–∫–ª–∞–¥–µ', '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è'];
    const csvRows = [headers.join(',')];
    
    products.forEach(product => {
        const row = [
            `"${product.id}"`,
            `"${product.name}"`,
            product.price,
            `"${product.category}"`,
            product.stock || 0,
            `"${product.created_at}"`
        ];
        csvRows.push(row.join(','));
    });
    
    const csvContent = csvRows.join('\n');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
    bot.sendDocument(chatId, Buffer.from(csvContent), {
        caption: 'üì• –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ CSV',
        filename: `products_${new Date().toISOString().slice(0, 10)}.csv`
    });
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
async function exportToJSON(chatId) {
    const products = await getProducts();
    
    if (products.length === 0) {
        bot.sendMessage(chatId, 'üì≠ –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.');
        return;
    }
    
    const jsonContent = JSON.stringify(products, null, 2);
    
    bot.sendDocument(chatId, Buffer.from(jsonContent), {
        caption: 'üì• –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ JSON',
        filename: `products_${new Date().toISOString().slice(0, 10)}.json`
    });
}

// ============================================
// –ó–ê–ü–£–°–ö –ë–û–¢–ê
// ============================================

console.log('ü§ñ –ê–¥–º–∏–Ω-–±–æ—Ç –∑–∞–ø—É—â–µ–Ω...');
console.log('üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π...');

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.on('polling_error', (error) => {
    console.error('–û—à–∏–±–∫–∞ polling:', error.code);
});

bot.on('webhook_error', (error) => {
    console.error('–û—à–∏–±–∫–∞ webhook:', error.message);
});

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
setInterval(async () => {
    try {
        const stats = await getShopStats();
        console.log(`üîÑ –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω. –¢–æ–≤–∞—Ä–æ–≤: ${stats.totalProducts}`);
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error.message);
    }
}, 300000); // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

